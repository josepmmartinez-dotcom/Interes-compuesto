<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json">
  <title>Simulador de Capital Acumulado</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #000000;
      --card: #0b0f13;
      --fg: #e6eef6;
      --muted: #9aa3b2;
      --border: rgba(255,255,255,0.06);
      --grid: rgba(255,255,255,0.04);
      --accent: #1fb6ff; /* bright blue accent */
    }

    * { box-sizing: border-box; transition: color .12s ease, background-color .12s ease, border-color .12s ease; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 24px; background: var(--bg); color: var(--fg); }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 6px; color: var(--fg); }
    .sub { margin: 0 0 18px; color: var(--muted); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 6px 28px rgba(0,0,0,0.6); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 820px){ .grid { grid-template-columns: 1fr; } }
    label { display: block; font-size: 14px; margin: 0 0 6px; color: var(--muted); }
    input { width: 100%; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; font-size: 16px; background: #071018; color: var(--fg); }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 820px){ .row { grid-template-columns: 1fr; } }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    @media (max-width: 820px){ .kpis { grid-template-columns: 1fr; } }
    .kpi { background: transparent; border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; padding: 12px; }
    .kpi .t { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .kpi .v { font-size: 22px; font-weight: 700; color: var(--accent); }
    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.06); background: transparent; color: var(--fg); cursor: pointer; font-size: 14px; }
    button.primary { border: none; background: linear-gradient(90deg, var(--accent), #2dd4ff); color: #02121a; box-shadow: 0 6px 18px rgba(31,102,235,0.12); }
    button:hover { filter: brightness(1.04); }
    canvas { width: 100%; height: 360px; border-radius: 12px; background: transparent; display:block; border: 1px solid rgba(255,255,255,0.04); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; color: var(--fg); }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .hint { font-size: 13px; color: var(--muted); margin-top: 8px; }

    /* Mobile optimizations */
    button, input { -webkit-tap-highlight-color: rgba(255,255,255,0.04); touch-action: manipulation; }
    @media (max-width: 640px) {
      body { margin: 12px; }
      h1 { font-size: 22px; }
      .wrap { padding: 0 8px; }
      .card { padding: 14px; border-radius: 14px; }
      input { font-size: 18px; padding: 12px 14px; }
      button { font-size: 16px; padding: 12px 14px; width: 100%; min-height: 44px; border-radius: 10px; }
      .actions { flex-direction: column; gap: 10px; }
      .kpi .v { font-size: 20px; }
      canvas { height: 260px; }
      .kpis { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      .grid { gap: 12px; }
      .card + .card { margin-top: 6px; }
      .table-wrap, #tableWrap { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Capital acumulado üìà</h1>
    <p class="sub">Simulador simple con inter√©s compuesto (una vez al a√±o).</p>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <label for="principal">Capital inicial (‚Ç¨)</label>
            <input id="principal" type="text" inputmode="numeric" pattern="[0-9\.\,]*" value="50.000" />
          </div>
          <div>
            <label for="rate">Ganancia por inversi√≥n (%)</label>
            <input id="rate" type="number" step="0.1" value="20" />
          </div>
          <div>
            <label for="years">N√∫mero de inversiones</label>
            <input id="years" type="number" min="1" step="1" value="20" />
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnCalc">Calcular</button>
          <button id="btnReset">Reset</button>
          <button id="btnCSV">Descargar tabla (CSV)</button>
          <button id="btnInstall" style="display:none">Instalar</button>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Capital final</div>
            <div class="v" id="kpiFinal">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Ganancia total</div>
            <div class="v" id="kpiGain">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Multiplicador</div>
            <div class="v" id="kpiMult">‚Äî</div>
          </div>
        </div>

        <div class="hint">
          Nota: esto no incluye aportaciones adicionales, impuestos, inflaci√≥n ni comisiones. Es la ‚Äúversi√≥n inocente‚Äù del inter√©s compuesto üòÑ
        </div>

        <details class="hint" style="margin-top:10px;">
          <summary style="cursor:pointer;">C√≥mo ejecutar en m√≥vil</summary>
          <ol style="margin:8px 0 0 18px; color:var(--muted);">
            <li>Abrir el archivo en un servidor (recomendado) o subirlo a GitHub Pages/Netlify.</li>
            <li>Para servidor local: en tu PC, ejecuta <code>python -m http.server 8000</code> en la carpeta del proyecto y abre en el m√≥vil <code>http://&lt;tu-ip&gt;:8000/</code>. (Ambos dispositivos en la misma red)</li>
            <li>Si prefieres publicar r√°pido: sube a GitHub y activa GitHub Pages, o sube a Netlify/Vercel.</li>
            <li>¬øQuieres que lo convierta en PWA (instalable) o que lo suba a GitHub Pages por ti? D√≠melo y lo hago.</li>
          </ol>
        </details> 
      </div>

      <div class="card">
        <canvas id="chart" aria-label="Gr√°fico de evoluci√≥n"></canvas>
        <div id="tableWrap"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const fmtEUR = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
  const fmtInt = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 });

  // Helpers to parse and format numbers with Spanish separators ('.' thousands, ',' decimals)
  function parseNumberFromInput(str) {
    const s = String(str || '').replace(/\./g, '').replace(',', '.').trim();
    return Number(s) || 0;
  }
  function formatPrincipal(value) {
    const n = (typeof value === 'number') ? value : parseNumberFromInput(value);
    return fmtInt.format(Math.round(n));
  }

  function computeSeries(principal, ratePct, years) {
    const r = ratePct / 100;
    const series = [{ year: 0, capital: principal }];
    for (let y = 1; y <= years; y++) {
      const prev = series[y - 1].capital;
      const next = prev * (1 + r);
      series.push({ year: y, capital: next });
    }
    return series;
  }

  function drawChart(series) {
    const canvas = $('chart');
    const cs = getComputedStyle(document.documentElement);
    const accent = (cs.getPropertyValue('--accent') || '#1fb6ff').trim();
    const fg = (cs.getPropertyValue('--fg') || '#e6eef6').trim();
    const gridColor = (cs.getPropertyValue('--grid') || 'rgba(255,255,255,0.04)').trim();
    const axisColor = (cs.getPropertyValue('--border') || 'rgba(255,255,255,0.06)').trim();

    // HiDPI canvas sizing
    const ratio = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 900;
    const cssH = parseInt(getComputedStyle(canvas).height) || 360;
    canvas.width = Math.floor(cssW * ratio);
    canvas.height = Math.floor(cssH * ratio);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.clearRect(0, 0, cssW, cssH);

    // Padding & plotting area (CSS pixels)
    const pad = { l: 56, r: 18, t: 16, b: 44 };
    const W = cssW, H = cssH;
    const x0 = pad.l, y0 = pad.t;
    const x1 = W - pad.r, y1 = H - pad.b;

    // Data extents
    const maxY = Math.max(...series.map(d => d.capital));
    const minY = 0; // baseline
    const maxX = Math.max(...series.map(d => d.year));
    const minX = 0;

    const x = (year) => x0 + (year - minX) * (x1 - x0) / (maxX - minX || 1);
    const y = (val)  => y1 - (val - minY) * (y1 - y0) / (maxY - minY || 1);

    // Background (subtle)
    // ctx.fillStyle = 'rgba(255,255,255,0.01)';
    // ctx.fillRect(x0, y0, x1 - x0, y1 - y0);

    // Axes lines
    ctx.lineWidth = 1;
    ctx.strokeStyle = axisColor;
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x0, y1);
    ctx.lineTo(x1, y1);
    ctx.stroke();

    // Y grid & ticks
    ctx.font = '12px system-ui, -apple-system, "Segoe UI", Roboto, Arial';
    const ticks = 5;
    for (let i = 0; i <= ticks; i++) {
      const v = minY + (maxY - minY) * (i / ticks);
      const yy = y(v);

      ctx.strokeStyle = gridColor;
      ctx.beginPath();
      ctx.moveTo(x0, yy);
      ctx.lineTo(x1, yy);
      ctx.stroke();

      ctx.fillStyle = fg;
      ctx.globalAlpha = 0.9;
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      ctx.fillText(fmtEUR.format(v), x0 - 8, yy);
      ctx.globalAlpha = 1;
    }

    // X ticks
    ctx.strokeStyle = gridColor;
    ctx.fillStyle = fg;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    const step = Math.max(1, Math.round(maxX / 10));
    for (let year = 0; year <= maxX; year += step) {
      const xx = x(year);
      ctx.beginPath();
      ctx.moveTo(xx, y1);
      ctx.lineTo(xx, y1 + 6);
      ctx.stroke();
      ctx.fillText(String(year), xx, y1 + 10);
    }

    // Line (accent gradient)
    ctx.lineWidth = 2.5;
    const grad = ctx.createLinearGradient(x0, 0, x1, 0);
    grad.addColorStop(0, accent);
    grad.addColorStop(1, 'rgba(255,255,255,0.85)');
    ctx.strokeStyle = grad;
    ctx.beginPath();
    series.forEach((d, i) => {
      const xx = x(d.year);
      const yy = y(d.capital);
      if (i === 0) ctx.moveTo(xx, yy);
      else ctx.lineTo(xx, yy);
    });
    ctx.stroke();

    // Glow for the line (subtle)
    ctx.save();
    ctx.globalAlpha = 0.06;
    ctx.lineWidth = 10;
    ctx.strokeStyle = accent;
    ctx.beginPath();
    series.forEach((d, i) => {
      const xx = x(d.year);
      const yy = y(d.capital);
      if (i === 0) ctx.moveTo(xx, yy);
      else ctx.lineTo(xx, yy);
    });
    ctx.stroke();
    ctx.restore();

    // Points
    ctx.fillStyle = accent;
    ctx.strokeStyle = '#0b1220';
    series.forEach((d) => {
      ctx.beginPath();
      ctx.arc(x(d.year), y(d.capital), 3.6, 0, Math.PI * 2);
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.stroke();
    });

    // Title
    ctx.fillStyle = fg;
    ctx.font = '600 13px system-ui, -apple-system, "Segoe UI", Roboto, Arial';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText('Evoluci√≥n del capital', x0, 2);
  }

  function renderTable(series) {
    const rows = series.map(d => `
      <tr>
        <td>${d.year}</td>
        <td>${fmtEUR.format(d.capital)}</td>
      </tr>
    `).join('');

    $('tableWrap').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>N.¬∫ inversi√≥n</th>
            <th>Capital</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table> 
    `;
  }

  function updateKPIs(series, principal) {
    const final = series[series.length - 1].capital;
    const gain = final - principal;
    const mult = principal > 0 ? (final / principal) : 0;

    $('kpiFinal').textContent = fmtEUR.format(final);
    $('kpiGain').textContent  = fmtEUR.format(gain);
    $('kpiMult').textContent  = mult ? (mult.toFixed(2) + '√ó') : '‚Äî';
  }

  function downloadCSV(series) {
    const header = 'year,capital\n';
    const body = series.map(d => `${d.year},${d.capital}`).join('\n');
    const blob = new Blob([header + body], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'evolucion_capital.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function calcAndRender() {
    const principalNum = parseNumberFromInput($('principal').value);
    const rate = Number($('rate').value);
    const years = Number($('years').value);

    const safePrincipal = isFinite(principalNum) && principalNum >= 0 ? principalNum : 0;
    const safeRate = isFinite(rate) ? rate : 0;
    const safeYears = isFinite(years) && years >= 1 ? Math.floor(years) : 1;

    // show formatted principal in the input
    $('principal').value = formatPrincipal(safePrincipal);

    const series = computeSeries(safePrincipal, safeRate, safeYears);
    drawChart(series);
    renderTable(series);
    updateKPIs(series, safePrincipal);
    window.__series = series; // stash for CSV
  }

  $('btnCalc').addEventListener('click', calcAndRender);
  $('btnReset').addEventListener('click', () => {
    $('principal').value = formatPrincipal(50000);
    $('rate').value = 20;
    $('years').value = 20;
    calcAndRender();
  });

  $('btnCSV').addEventListener('click', () => {
    if (!window.__series) calcAndRender();
    downloadCSV(window.__series);
  });

  // Auto-calc on input changes
  ['principal','rate','years'].forEach(id => $(id).addEventListener('input', calcAndRender));

  // Better UX for principal input: show raw number while editing, format on blur
  const $principal = $('principal');
  $principal.addEventListener('focus', (e) => {
    e.target.value = String(e.target.value).replace(/\./g, '');
    // move caret to end
    setTimeout(() => { e.target.selectionStart = e.target.selectionEnd = e.target.value.length; }, 0);
  });
  $principal.addEventListener('blur', (e) => {
    e.target.value = formatPrincipal(e.target.value);
    calcAndRender();
  });

  // Ensure the input shows formatted default value before first render
  $principal.value = formatPrincipal($principal.value || 50000);

  // Redraw on resize (debounced) so the canvas remains crisp on orientation change
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => { if (window.__series) drawChart(window.__series); }, 150);
  });
  window.addEventListener('orientationchange', () => {
    setTimeout(() => { if (window.__series) drawChart(window.__series); }, 200);
  });

  // First render
  calcAndRender();

  // Register service worker and show a custom "Install" button when available
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        console.log('Service worker registered', reg);

        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New update available
              if (confirm('Hay una actualizaci√≥n disponible. ¬øRecargar para aplicar?')) {
                window.location.reload();
              }
            }
          });
        });
      } catch (err) {
        console.warn('SW registration failed', err);
      }
    });
  }

  // Handle beforeinstallprompt to show a custom install button
  let deferredPrompt = null;
  const btnInstall = document.getElementById('btnInstall');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btnInstall) btnInstall.style.display = 'inline-block';
  });

  if (btnInstall) {
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        btnInstall.style.display = 'none';
      }
      deferredPrompt = null;
    });
  }
</script>
</body>
</html>
